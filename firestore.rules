rules_version = '2';

// Firestore rules
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return profile.user_type == 'admin';
    }
    
    function isChallengeOrganizer(challengeId) {
      let challenge = get(/databases/$(database)/documents/challenges/$(challengeId)).data;
      return challenge.createdBy == request.auth.uid;
    }
    
    function isParticipant() {
      let profile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return profile.user_type == 'participant';
    }

    function isTeamOwner(teamId) {
      let team = get(/databases/$(database)/documents/teams/$(teamId)).data;
      return request.auth.uid in team.admins;
    }

    function isTeamMember(teamId) {
      return exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)).data.status == 'active';
    }
    
    // Users (main profiles) and their subcollections
    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      match /challenges/{challengeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /teams/{teamId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (
          request.auth.uid == userId || 
          isAdmin()
        );
      }
      
      match /invitations/{invitationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null;
      }
      
      match /applications/{applicationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && (
          request.auth.uid == userId ||
          isAdmin()
        );
      }
    }
    
    // Organizations collection
    match /organizations/{organizationId} {
      allow read: if true;
      allow write: if request.auth != null;
      
      // Staff subcollection for organization members
      match /staff/{staffId} {
        // Allow reading staff list to authenticated users
        allow read: if request.auth != null;
        
        // Allow creating staff during organization creation
        allow create: if request.auth != null && (
          request.auth.uid == staffId ||
          exists(/databases/$(database)/documents/organizations/$(organizationId)/staff/$(request.auth.uid))
        );
        
        // Allow updating own profile or by organization admins
        allow update: if request.auth != null && (
          request.auth.uid == staffId ||
          get(/databases/$(database)/documents/organizations/$(organizationId)/staff/$(request.auth.uid)).data.role in ['owner', 'admin']
        );
        
        // Allow deletion by organization admins
        allow delete: if request.auth != null && 
          get(/databases/$(database)/documents/organizations/$(organizationId)/staff/$(request.auth.uid)).data.role in ['owner', 'admin'];
      }
    }
    
    // Public profiles (for teams, challenges, community)
    match /profiles/{profileId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == profileId;
    }
    
    // Challenges collection
    match /challenges/{challengeId} {
      allow read: if true;
      
      // Allow partners to create and write challenges
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.user_type == 'partner' && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'approved';
      
      // Special case for incrementing participant count only
      allow update: if request.auth != null && 
                   request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants']) &&
                   request.resource.data.participants == resource.data.participants + 1;
    }
    
    // Submissions collection - key for joining challenges
    match /submissions/{submissionId} {
      // Allow reading your own submissions
      allow read: if request.auth != null && 
                 (submissionId.split('_')[0] == request.auth.uid || isAdmin() || 
                 isChallengeOrganizer(resource.data.challengeId)
                 );
      
      // Allow creating submissions
      allow create: if request.auth != null && 
                   submissionId.split('_')[0] == request.auth.uid &&
                   request.resource.data.userId == request.auth.uid;
      
      // Allow updating your own submissions
      allow update: if request.auth != null && 
                   request.resource.data.userId == request.auth.uid &&
                   resource.data.userId == request.auth.uid;
      
      // Allow deleting your own submissions
      allow delete: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
    }
    
    
    // Main teams collection
    match /teams/{teamId} {
      // Allow reading teams if:
      // 1. Team is public
      // 2. User is in admins array
      // 3. User has a team reference in their profile (is a member)
      // 4. User is admin
      allow read: if request.auth != null && (
        (resource != null && resource.data.visibility == 'public') ||
        (resource != null && request.auth.uid in resource.data.admins) ||
        exists(/databases/$(database)/documents/users/$(request.auth.uid)/teams/$(teamId)) ||
        isAdmin()
      );
      
      // Allow listing/querying teams for discovery
      allow list: if request.auth != null;

      // Allow authenticated participants to create teams
      allow create: if request.auth != null && 
                      request.resource.data.challengeId is string && 
                      request.resource.data.createdBy == request.auth.uid &&
                      request.auth.uid in request.resource.data.admins;
                      
      allow update: if request.auth != null && (
        // Team admins can update anything
        request.auth.uid in resource.data.admins || 
        isAdmin() ||
        // Users can update when joining a team (increment members by 1 only)
        (
          request.resource.data.currentMembers == resource.data.currentMembers + 1 &&
          (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentMembers', 'lastActivity']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentMembers', 'lastActivity', 'admins'])
          )
        )
      );
      
      allow delete: if request.auth != null && (
        request.auth.uid in resource.data.admins || 
        isAdmin()
      );

      // Team members as subcollection
      match /members/{userId} {
        allow read: if request.auth != null;
        
        // Allow creating member during team creation, by team admins, or when accepting invitation
        allow create: if request.auth != null && (
          // Creating yourself as owner during team creation
          (request.auth.uid == userId && request.resource.data.role == 'owner') ||
          // Team admin adding members (including when invitation is accepted)
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          // User joining via accepted invitation - allow if they're adding themselves as member
          (request.auth.uid == userId && request.resource.data.role == 'member') ||
          isAdmin()
        );
        
        allow update: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
        
        allow delete: if request.auth != null && (
          request.auth.uid == userId ||
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
      }

      // Team invitations as subcollection
      match /invitations/{invitationId} {
        allow read: if request.auth != null;
        
        allow create: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          request.auth.uid == request.resource.data.invitedBy ||
          isAdmin()
        );
        
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.invitedUserId || 
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
        
        allow delete: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
      }

      // Team applications as subcollection
      match /applications/{applicationId} {
        allow read: if request.auth != null;
        
        allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.applicantId;
        
        allow update: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
        
        allow delete: if request.auth != null && (
          request.auth.uid == resource.data.applicantId || 
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.admins ||
          isAdmin()
        );
      }

      // Team challenges as subcollection
      match /challenges/{challengeId} {
        allow read: if isTeamMember(teamId) || isTeamOwner(teamId) || isAdmin();
        allow create: if isTeamMember(teamId) || isTeamOwner(teamId) || isAdmin();
        allow update: if isTeamMember(teamId) || isTeamOwner(teamId) || isAdmin();
        allow delete: if isTeamMember(teamId) || isTeamOwner(teamId) || isAdmin();
      }
    }
  }
}